<!DOCTYPE html>
<html>

<head>
    <title>Add Student | Visual Softech</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            background: #f5f5f5;
        }

        .subject-row input {
            width: 90%;
        }

        img.preview {
            width: 60px;
            height: 60px;
            margin-right: 5px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <script>
        if (localStorage.getItem("loggedIn") !== "true") {
            window.location.href = "login.html";
        }
    </script>

    <div class="container mt-4">

        <h3>Add New Student</h3>
        <hr>

        <div class="card p-4 shadow-sm">

            <div class="row mb-3">
                <div class="col-md-6">
                    <label>Name</label>
                    <input id="name" class="form-control">
                </div>

                <div class="col-md-3">
                    <label>Age</label>
                    <input id="age" type="number" class="form-control">
                </div>

                <div class="col-md-3">
                    <label>Date of Birth</label>
                    <input id="dob" type="date" class="form-control">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label>Address</label>
                    <input id="address" class="form-control">
                </div>

                <div class="col-md-6">
                    <label>State</label>
                    <select id="state" class="form-control"></select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label>Phone Number</label>
                    <input id="phone" class="form-control" placeholder="+91-XXXXXXXXXX">
                </div>

                <div class="col-md-6">
                    <label>Photos (multiple)</label>
                    <input id="photos" type="file" class="form-control" multiple accept="image/*">
                </div>
            </div>

            <div id="previewContainer" class="mb-3"></div>

            <h5>Subjects</h5>

            <table class="table table-bordered" id="subjectsTable">
                <thead>
                    <tr><th>Subject Name</th><th width="120">Action</th></tr>
                </thead>
                <tbody>
                    <tr class="subject-row">
                        <td><input class="form-control subject-input"></td>
                        <td><button class="btn btn-danger btn-sm" onclick="removeRow(this)">Delete</button></td>
                    </tr>
                </tbody>
            </table>

            <button class="btn btn-secondary mb-3" onclick="addRow()">+ Add Subject</button>

            <br>

            <button onclick="saveStudent()" class="btn btn-primary">Save</button>
            <a href="index.html" class="btn btn-outline-secondary">Cancel</a>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    

    <script>

        
        const apiBase = window.location.origin + "/api";

        // Load states
        function loadStates() {
            $.get(apiBase + "/students/states", (res) => {
                $("#state").html("");
                res.forEach(s => {
                    $("#state").append(`<option value="${s.id}">${s.state_name}</option>`);
                });
            });
        }
        loadStates();

        let compressedPhotos = [];

        function addRow() {
            $("#subjectsTable tbody").append(`
                    <tr class="subject-row">
                        <td><input class="form-control subject-input"></td>
                        <td><button class="btn btn-danger btn-sm" onclick="removeRow(this)">Delete</button></td>
                    </tr>
                `);
        }

        function removeRow(btn) { $(btn).closest("tr").remove(); }

        function compressImage(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function () {
                        let canvas = document.createElement("canvas");
                        let ctx = canvas.getContext("2d");
                        canvas.width = 200;
                        canvas.height = 200;
                        ctx.drawImage(img, 0, 0, 200, 200);
                        let compressed = canvas.toDataURL("image/jpeg", 0.2);
                        resolve(compressed);
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        $("#photos").on("change", async function () {
            compressedPhotos = [];
            $("#previewContainer").html("");
            for (let file of this.files) {
                let comp = await compressImage(file);
                compressedPhotos.push(comp);
                $("#previewContainer").append(`<img class="preview" src="${comp}" />`);
            }
        });

        function saveStudent() {

            let subjects = [];
            $(".subject-input").each(function () {
                let val = $(this).val().trim();
                if (val) subjects.push({ subjectName: val });
            });

            let data = {
                name: $("#name").val().trim(),
                age: parseInt($("#age").val()),
                dob: $("#dob").val(),
                address: $("#address").val(),
                stateId: parseInt($("#state").val()),
                phoneNumber: $("#phone").val(),
                photosJson: JSON.stringify(compressedPhotos),
                subjects: subjects
            };

            $.ajax({
                url: apiBase + "/students/create",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function () {
                    Swal.fire("Success", "Student added successfully", "success")
                        .then(() => { window.location.href = "index.html"; });
                },
                error: function () {
                    Swal.fire("Error", "Failed to save student", "error");
                }
            });
        }

    </script>


</body>
</html>
